name: CI/CD Pipeline

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  # ===============================================
  # CI: Testear el C√≥digo
  # ===============================================
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.4'
        extensions: mbstring, xml, bcmath, mysql
        coverage: none

    - name: Copy .env
      run: cp .env.example .env

    - name: Install Dependencies
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    - name: Generate Key
      run: php artisan key:generate

    - name: Directory Permissions
      run: chmod -R 777 storage bootstrap/cache

    - name: Run Migration
      env:
        DB_CONNECTION: mysql
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        DB_DATABASE: testing_db
        DB_USERNAME: root
        DB_PASSWORD: root
      run: php artisan migrate --force

    - name: Install Frontend Dependencies & Build
      run: |
        npm ci
        npm run build

    - name: Execute Tests (Unit & Feature)
      env:
        DB_CONNECTION: mysql
        DB_HOST: 127.0.0.1
        DB_PORT: 3306
        DB_DATABASE: testing_db
        DB_USERNAME: root
        DB_PASSWORD: root
      run: php artisan test

  # ===============================================
  # CD: Desplegar a Producci√≥n
  # ===============================================
  deploy:
    needs: test
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          # Parar si hay error
          set -e

          echo "üöÄ Iniciando Despliegue en ${{ secrets.PROJECT_PATH }}..."
          cd ${{ secrets.PROJECT_PATH }}

          # Fix dubious ownership error
          git config --global --add safe.directory ${{ secrets.PROJECT_PATH }}

          echo "‚¨áÔ∏è Bajando cambios desde GitHub..."
          # FORZAR el remote correcto (fix mismatch)
          # git remote set-url origin git@github.com:joyeria-sharvel/currency-hub.git
          git fetch origin
          git checkout master
          git reset --hard origin/master

          echo "üê≥ Reconstruyendo Contenedores (si es necesario)..."
          # Reconstruir servicios actualizados
          docker compose up -d --build currency-hub-php currency-hub-worker currency-hub-scheduler currency-hub-nginx

          echo "üì¶ Instalando Dependencias y Optimizando..."

          # Corregir Permisos (Crucial tras git pull y para npm cache)
          docker compose exec -T -u root currency-hub-php chown -R www-data:www-data /var/www

          # Ejecutar comandos dentro del contenedor PHP
          docker compose exec -T currency-hub-php composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader
          docker compose exec -T currency-hub-php php artisan migrate --force
          docker compose exec -T currency-hub-php php artisan optimize:clear
          docker compose exec -T currency-hub-php php artisan config:cache
          docker compose exec -T currency-hub-php php artisan route:cache
          docker compose exec -T currency-hub-php php artisan view:cache

          # Reiniciar colas para tomar el nuevo c√≥digo
          docker compose exec -T currency-hub-php php artisan queue:restart

          echo "‚úÖ Despliegue Completado Exitosamente."
